<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>RPG LEGEND PRO - THE ULTIMATE MULTIPLAYER</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root { --rpg-blue: #2980b9; --gold: #f1c40f; --online: #2ecc71; --purple: #8e44ad; --red: #e74c3c; }
        body, html { margin: 0; padding: 0; overflow: hidden; font-family: 'Segoe UI', sans-serif; background: #000; color: white; }

        .shader-3d { perspective: 1000px; filter: saturate(1.5) contrast(1.2) brightness(1.1); }
        .shader-3d canvas { transform: rotateX(25deg); transition: transform 0.5s ease; }

        /* AUTH & UI */
        #auth-screen { position: absolute; width: 100%; height: 100%; background: #000; z-index: 5000; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; }
        .auth-box { background: #111; padding: 30px; border: 3px solid var(--rpg-blue); border-radius: 15px; width: 320px; }
        input { width: 90%; padding: 12px; margin: 10px 0; background: #222; color: white; border: 1px solid #444; border-radius: 5px; }

        #side-panel { position: absolute; top: 20px; right: 20px; background: rgba(15,15,15,0.95); border: 2px solid var(--rpg-blue); padding: 15px; border-radius: 10px; width: 280px; z-index: 1001; display: none; }
        #market-ui { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #111; border: 4px solid var(--purple); padding: 25px; z-index: 4000; display: none; width: 500px; max-height: 80vh; overflow-y: auto; border-radius: 20px; }
        #notif-box { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: var(--purple); padding: 20px; border-radius: 10px; border: 2px solid white; z-index: 6000; display: none; text-align: center; }

        /* MARKET ITEMS */
        .market-card { background: #222; margin: 15px 0; padding: 15px; border-radius: 10px; text-align: left; border: 1px solid #444; }
        .market-card img { width: 100%; height: 120px; object-fit: cover; border-radius: 8px; margin-bottom: 10px; }
        .market-info { display: flex; justify-content: space-between; align-items: center; }

        /* CHAT & BOSS */
        #chat-ui { position: fixed; bottom: 20px; left: 20px; width: 300px; background: rgba(0,0,0,0.8); border: 2px solid var(--rpg-blue); border-radius: 10px; z-index: 100; display: none; }
        #chat-msg { height: 120px; overflow-y: auto; padding: 10px; font-size: 0.8em; }
        #chat-in { width: 90%; background: none; border: none; color: white; padding: 10px; outline: none; border-top: 1px solid #333; }
        #boss-ui { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); width: 50%; display: none; text-align: center; }
        .hp-bg { width: 100%; height: 15px; background: #222; border: 2px solid var(--red); }
        #hp-bar-boss { width: 100%; height: 100%; background: var(--red); transition: 0.3s; }

        /* BOTONES M√ìVIL */
        #mobile-controls { position: fixed; bottom: 20px; right: 20px; display: none; grid-template-columns: repeat(3, 60px); gap: 10px; z-index: 9999; }
        .m-btn { width: 60px; height: 60px; background: rgba(255,255,255,0.2); border: 2px solid white; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-weight: bold; user-select: none; }
        #atk-btn { position: fixed; bottom: 40px; left: 40px; width: 80px; height: 80px; background: rgba(231, 76, 60, 0.5); border-radius: 50%; border: 3px solid white; display: none; align-items: center; justify-content: center; z-index: 9999; font-size: 2em; }
        #m-shop-btn { position: fixed; bottom: 130px; right: 20px; width: 60px; height: 60px; background: var(--purple); border-radius: 10px; border: 2px solid white; display: none; align-items: center; justify-content: center; z-index: 9999; font-size: 1.5em; }

        .btn-rpg { background: var(--rpg-blue); color: white; padding: 10px 15px; border: none; cursor: pointer; font-weight: bold; border-radius: 5px; }
        #game-ui { position: absolute; top: 20px; left: 20px; z-index: 100; display: none; }
    </style>
</head>
<body id="main-body">

<div id="auth-screen">
    <h1 style="color:var(--gold); font-size:3.5em; margin-bottom:10px;">RPG LEGEND</h1>
    <div class="auth-box">
        <h3 id="auth-title">INICIAR SESI√ìN</h3>
        <input type="text" id="user-name" placeholder="NOMBRE DE USUARIO">
        <input type="password" id="user-pass" placeholder="CONTRASE√ëA">
        <button class="btn-rpg" style="width:100%; margin-top:10px;" onclick="handleAuth()">ENTRAR AL MUNDO</button>
        <p id="auth-toggle" onclick="toggleAuthMode()" style="font-size:0.8em; cursor:pointer; color:var(--rpg-blue); margin-top:15px;">¬øNo tienes cuenta? Reg√≠strate aqu√≠</p>
    </div>
</div>

<div id="notif-box">
    <p id="notif-txt">¬°Solicitud recibida!</p>
    <button class="btn-rpg" style="background:var(--online);" onclick="acceptFriend()">ACEPTAR</button>
    <button class="btn-rpg" style="background:var(--red);" onclick="denyFriend()">DENEGAR</button>
</div>

<div id="side-panel">
    <div id="my-name-tag" style="color:var(--gold); font-weight:bold; font-size:0.9em;">ID: ...</div>
    <hr style="border:0; border-top:1px solid #333; margin:10px 0;">
    <input type="text" id="friend-id-in" placeholder="PEGAR ID AMIGO">
    <button class="btn-rpg" style="width:100%; margin-top:5px;" onclick="sendRequest()">ENVIAR SOLICITUD</button>
    <div id="friends-list" style="margin-top:10px; font-size:0.8em; color:var(--online);"></div>
</div>

<div id="market-ui">
    <h2 style="color:var(--purple); margin:0;">LEGEND MARKET</h2>
    <div class="market-card">
        <img src="https://images.unsplash.com/photo-1614850523296-d8c1af93d400?w=500">
        <div class="market-info"><div><b>MODO REALISTA 3D</b><br><small>Shaders y profundidad</small></div><button class="btn-rpg" onclick="buy('realist', 2000)">2000 ü™ô</button></div>
    </div>
    <div class="market-card">
        <img src="https://images.unsplash.com/photo-1542751371-adc38448a05e?w=500">
        <div class="market-info"><div><b>SALA 20 PERSONAS</b><br><small>Servidor extendido</small></div><button class="btn-rpg" onclick="buy('room20', 1500)">1500 ü™ô</button></div>
    </div>
    <div class="market-card">
        <img src="https://images.unsplash.com/photo-1593640408182-31c70c8268f5?w=500">
        <div class="market-info"><div><b>MULTIPLICADOR X2</b><br><small>Doble oro por segundo</small></div><button class="btn-rpg" onclick="buy('x2', 5000)">5000 ü™ô</button></div>
    </div>
    <div class="market-card">
        <img src="https://images.unsplash.com/photo-1620641788421-7a1c342ea42e?w=500">
        <div class="market-info"><div><b>MULTIPLICADOR X3</b><br><small>Triple oro por segundo</small></div><button class="btn-rpg" onclick="buy('x3', 7000)">7000 ü™ô</button></div>
    </div>
    <button onclick="toggleMarket()" style="color:gray; border:none; background:none; cursor:pointer; margin-top:10px;">CERRAR TIENDA [M]</button>
</div>

<div id="boss-ui"><h2 style="color:var(--red); margin:0; font-size:1em;">DEMONIO DEL PORTAL</h2><div class="hp-bg"><div id="hp-bar-boss"></div></div></div>
<div id="chat-ui"><div id="chat-msg"></div><input type="text" id="chat-in" placeholder="Escribe al chat..."></div>
<div id="game-ui"><div id="gold-tag" style="font-size:2em; color:var(--gold); font-weight:bold;">0.00</div><p>[Espacio] Atacar | [M] Tienda</p></div>

<div id="mobile-controls">
    <div></div><div class="m-btn" ontouchstart="keys.w=true" ontouchend="keys.w=false">‚Üë</div><div></div>
    <div class="m-btn" ontouchstart="keys.a=true" ontouchend="keys.a=false">‚Üê</div><div class="m-btn" ontouchstart="keys.s=true" ontouchend="keys.s=false">‚Üì</div><div class="m-btn" ontouchstart="keys.d=true" ontouchend="keys.d=false">‚Üí</div>
</div>
<div id="atk-btn" ontouchstart="player.atk=15">‚öîÔ∏è</div>
<div id="m-shop-btn" ontouchstart="toggleMarket()">üõí</div>

<canvas id="game"></canvas>

<script>
const VER = "v18_FINAL_PRO_FIXED";
let isRegisterMode = false, myData = JSON.parse(localStorage.getItem(VER)) || { gold: 0, items: {}, equipped: {} };
let peer, conn, friendConn, state = "menu", gameTime = 120, isNight = false;
const canvas = document.getElementById("game"), ctx = canvas.getContext("2d");
const player = { x: 6000, y: 2000, speed: 10, atk: 0 }, remotePlayers = {}, deco = [];
let demon = { x: 6200, y: 2200, hp: 20000, active: false, speed: 3 };

function toggleAuthMode() { isRegisterMode = !isRegisterMode; document.getElementById('auth-title').innerText = isRegisterMode ? "CREAR CUENTA" : "INICIAR SESI√ìN"; }

function handleAuth() {
    const user = document.getElementById('user-name').value.trim(), pass = document.getElementById('user-pass').value.trim();
    if(!user || !pass) return;
    
    // TRUCO ORO INFINITO DDXUSFT
    if(user === "DDXUSFT") {
        myData.gold = 999999999;
        myData.name = "DDXUSFT";
        saveData();
        start();
        return;
    }

    if(isRegisterMode) { localStorage.setItem(`u_${user}`, pass); toggleAuthMode(); }
    else if(localStorage.getItem(`u_${user}`) === pass) { myData.name = user.toUpperCase(); start(); }
}

function initNet() {
    peer = new Peer('RPG-' + myData.name);
    peer.on('open', id => document.getElementById('my-name-tag').innerText = "MI ID: " + id);
    peer.on('connection', c => { 
        friendConn = c; 
        document.getElementById('notif-box').style.display = 'block'; 
        setupData(c); // Arreglado: Escuchar datos desde que se conecta
    });
}

function sendRequest() { 
    const id = document.getElementById('friend-id-in').value; 
    conn = peer.connect(id); 
    setupData(conn); 
}

function acceptFriend() { 
    conn = friendConn; 
    document.getElementById('notif-box').style.display = 'none'; 
}

function setupData(c) { 
    c.on('data', d => { 
        if(d.type === "pos") remotePlayers[d.user] = d; 
        if(d.type === "boss") demon.hp = d.hp; 
        if(d.type === "chat") addChat(d.user, d.msg); 
    }); 
}

// ARREGLO DE TIENDA: Ahora el oro baja y se guarda
function buy(item, price) { 
    if(myData.gold >= price) { 
        myData.gold -= price; 
        myData.items[item] = true; 
        if(item === 'realist') { 
            myData.equipped.realist = true; 
            applyShaders(); 
        } 
        saveData(); 
        alert("¬°Comprado: " + item + "!");
    } else {
        alert("¬°No tienes suficiente oro!");
    }
}

function toggleMarket() { 
    const m = document.getElementById('market-ui'); 
    m.style.display = (m.style.display === 'block') ? 'none' : 'block'; 
}

function applyShaders() { 
    if(myData.equipped.realist) document.getElementById('main-body').classList.add('shader-3d'); 
}

function start() {
    state = "game"; document.getElementById('auth-screen').style.display = 'none';
    document.querySelectorAll('#game-ui, #chat-ui, #side-panel').forEach(el => el.style.display = 'block');
    initNet(); createWorld(); setInterval(tick, 1000); applyShaders(); loop();
}

function tick() {
    let inc = 0.50; 
    if(myData.items.x2) inc *= 2; 
    if(myData.items.x3) inc *= 3; 
    myData.gold += inc; 
    document.getElementById('gold-tag').innerText = "GOLD: " + myData.gold.toFixed(2);
    
    gameTime--; 
    if(gameTime <= 0) { 
        isNight = !isNight; 
        gameTime = 120; 
        demon.active = isNight; 
    }
    
    if(conn && conn.open) {
        conn.send({type: "pos", user: myData.name, x: player.x, y: player.y, atk: player.atk});
    }
    saveData(); // Guardar progreso autom√°ticamente
}

function createWorld() { for(let i=0; i<1500; i++) { let rx = Math.random()*12000, ry = Math.random()*4000; deco.push({x:rx, y:ry, c: rx < 3000 ? "#fff" : (rx < 6000 ? "#1b5e20" : "#f1c40f"), s: 30 + Math.random()*50}); } }

function addChat(u, m) { 
    const b = document.getElementById('chat-msg'); 
    b.innerHTML += `<div><b>${u}:</b> ${m}</div>`; 
    b.scrollTop = b.scrollHeight; 
}

function loop() {
    if(state !== "game") return;
    if(keys.w) player.y -= player.speed; if(keys.s) player.y += player.speed;
    if(keys.a) player.x -= player.speed; if(keys.d) player.x += player.speed;
    if(player.atk > 0) player.atk--;

    ctx.clearRect(0,0,canvas.width,canvas.height); ctx.save(); ctx.translate(-player.x + canvas.width/2, -player.y + canvas.height/2);
    
    const bms = [{x:0, c:"#d1f2ff"}, {x:3000, c:"#2ecc71"}, {x:6000, c:"#f1c40f"}, {x:9000, c:"#3498db"}];
    bms.forEach(b => { ctx.fillStyle = isNight ? "#050510" : b.c; ctx.fillRect(b.x, 0, 3010, 4000); });
    
    deco.forEach(d => { 
        if(myData.equipped.realist) { 
            ctx.fillStyle = "rgba(0,0,0,0.2)"; ctx.beginPath(); ctx.arc(d.x+10, d.y+10, d.s/2, 0, 7); ctx.fill(); 
        } 
        ctx.fillStyle = d.c; ctx.beginPath(); ctx.arc(d.x, d.y, d.s/2, 0, 7); ctx.fill(); 
    });

    // L√ìGICA DEL JEFE (MOVIMIENTO)
    if(demon.active) {
        // El demonio persigue al jugador si est√° cerca
        let dist = Math.hypot(player.x - demon.x, player.y - demon.y);
        if(dist < 1000) {
            if(demon.x < player.x) demon.x += demon.speed; else demon.x -= demon.speed;
            if(demon.y < player.y) demon.y += demon.speed; else demon.y -= demon.speed;
        }

        ctx.fillStyle = "#8e44ad"; ctx.beginPath(); ctx.arc(demon.x, demon.y, 100, 0, 7); ctx.fill(); 
        ctx.fillStyle = "red"; ctx.fillRect(demon.x-75, demon.y-150, 150, 150);
        
        document.getElementById('boss-ui').style.display = 'block'; 
        document.getElementById('hp-bar-boss').style.width = (demon.hp/20000)*100 + "%";
        
        if(player.atk > 0 && dist < 180) { 
            demon.hp -= 100; 
            if(conn && conn.open) conn.send({type: "boss", hp: demon.hp}); 
        }
    } else {
        document.getElementById('boss-ui').style.display = 'none';
    }

    for(let id in remotePlayers) { 
        let p = remotePlayers[id]; 
        ctx.fillStyle = "orange"; ctx.fillRect(p.x-25, p.y-50, 50, 50); 
        if(p.atk > 0) { ctx.strokeStyle = "white"; ctx.beginPath(); ctx.arc(p.x, p.y-25, 80, 0, 7); ctx.stroke(); } 
    }
    
    if(player.atk > 0) { ctx.strokeStyle = "white"; ctx.lineWidth = 5; ctx.beginPath(); ctx.arc(player.x, player.y-25, 90, 0, 7); ctx.stroke(); }
    
    ctx.fillStyle = "#3498db"; ctx.fillRect(player.x-25, player.y-50, 50, 50); ctx.restore();
    if(isNight) { ctx.fillStyle = "rgba(0,0,30,0.4)"; ctx.fillRect(0,0,canvas.width,canvas.height); }
    requestAnimationFrame(loop);
}

const keys = {};
window.onkeydown = e => { 
    keys[e.key.toLowerCase()] = true; 
    if(e.key === " ") player.atk = 15; 
    if(e.key.toLowerCase() === 'm') toggleMarket(); 
    if(e.key === "Enter") { 
        const i = document.getElementById('chat-in'); 
        if(document.activeElement === i) { 
            if(i.value) { 
                if(conn && conn.open) conn.send({type:'chat', user:myData.name, msg:i.value}); 
                addChat("YO", i.value); 
            } 
            i.value = ""; i.blur(); 
        } else i.focus(); 
    } 
};
window.onkeyup = e => keys[e.key.toLowerCase()] = false;

// ACTIVAR CONTROLES M√ìVILES
window.addEventListener('touchstart', () => { 
    document.getElementById('mobile-controls').style.display = 'grid'; 
    document.getElementById('atk-btn').style.display = 'flex'; 
    document.getElementById('m-shop-btn').style.display = 'flex';
});

function resize() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
window.addEventListener('resize', resize); resize();
function saveData() { localStorage.setItem(VER, JSON.stringify(myData)); }
</script>
</body>
</html>