<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Backrooms 360: Juicio Final</title>
    <style>
        body { margin: 0; overflow: hidden; background: #000; font-family: 'Courier New', monospace; touch-action: none; }
        #ui { position: absolute; bottom: 20px; left: 20px; color: #ffff00; z-index: 10; pointer-events: none; }
        #stamina-bar { width: 180px; height: 8px; background: rgba(255,255,0,0.2); border: 1px solid #ff0; margin-top: 5px; }
        #stamina-fill { width: 100%; height: 100%; background: #ff0; }
        #lvl-tag { position: absolute; top: 20px; left: 20px; color: #fff; font-size: 20px; text-shadow: 2px 2px #000; z-index: 10; }
        
        /* CONTROLES MÓVIL OPTIMIZADOS */
        #mobile-ui { display: none; }
        #joystick-zone { position: absolute; bottom: 40px; left: 40px; width: 100px; height: 100px; background: rgba(255,255,255,0.05); border: 2px solid rgba(255,255,0,0.2); border-radius: 50%; z-index: 100; }
        #joystick-stick { position: absolute; top: 30px; left: 30px; width: 40px; height: 40px; background: #ff0; border-radius: 50%; opacity: 0.4; }
        #btn-run { position: absolute; bottom: 45px; right: 35px; width: 75px; height: 75px; background: rgba(255,255,0,0.15); border: 2px solid #ff0; border-radius: 50%; z-index: 100; color: #ff0; display: flex; justify-content: center; align-items: center; font-weight: bold; font-size: 14px; user-select: none; }

        #final-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: none; flex-direction: column; justify-content: center; align-items: center; z-index: 200; transition: background 2s; }
        #final-text { color: #8b0000; text-align: center; font-size: 24px; font-weight: 900; opacity: 0; transition: opacity 2s; padding: 20px; }
        #heaven-msg { position: absolute; top: 40%; left: 50%; transform: translate(-50%, -50%); color: #ccaa00; font-size: 24px; text-align: center; font-weight: bold; opacity: 0; transition: opacity 2s; pointer-events: none; width: 80%; }
        #victory-screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: white; display: none; justify-content: center; align-items: center; z-index: 500; color: #ccaa00; font-size: 35px; font-weight: bold; }
    </style>
</head>
<body>
    <div id="lvl-tag">NIVEL: 0</div>
    <div id="ui">VIDAS: <span id="lives">3</span><div id="stamina-bar"><div id="stamina-fill"></div></div></div>
    
    <div id="mobile-ui">
        <div id="joystick-zone"><div id="joystick-stick"></div></div>
        <div id="btn-run">RUN</div>
    </div>

    <div id="final-overlay"><div id="final-text"></div></div>
    <div id="heaven-msg">HAS LLEGADO AL CIELO...<br>TUS PECADOS HAN SIDO BORRADOS</div>
    <div id="victory-screen">LIBERTAD</div>

    <script type="module">
        import * as THREE from 'https://cdn.skypack.dev/three@0.136.0';
        import { PointerLockControls } from 'https://cdn.skypack.dev/three@0.136.0/examples/jsm/controls/PointerLockControls.js';

        let currentLevel = 0, isFinal = false, inHeaven = false, lives = 3, stamina = 100;
        let collidableWalls = [], monster, door, heart, heavenLight, keys = {};
        let moveX = 0, moveZ = 0, yaw = 0, pitch = 0;
        let isMobile = ('ontouchstart' in window || navigator.maxTouchPoints > 0);

        if(isMobile) document.getElementById('mobile-ui').style.display = 'block';

        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(window.devicePixelRatio);
        document.body.appendChild(renderer.domElement);

        const controls = new PointerLockControls(camera, document.body);
        document.addEventListener('mousedown', () => { if(!isMobile && (!isFinal || inHeaven)) controls.lock(); });

        const light = new THREE.PointLight(0xffffff, 1.3, 15);
        camera.add(light); scene.add(camera);

        // --- MANEJO DE CÁMARA 360 TÁCTIL ---
        let lastTouchX = 0, lastTouchY = 0;
        window.addEventListener('touchstart', e => {
            const touch = e.touches[0];
            if (touch.clientX > window.innerWidth / 2) {
                lastTouchX = touch.clientX;
                lastTouchY = touch.clientY;
            }
        });

        window.addEventListener('touchmove', e => {
            for(let i=0; i<e.touches.length; i++) {
                const t = e.touches[i];
                // Lado Izquierdo: Movimiento
                if (t.clientX < window.innerWidth / 2) {
                    const zone = document.getElementById('joystick-zone').getBoundingClientRect();
                    const centerX = zone.left + zone.width/2;
                    const centerY = zone.top + zone.height/2;
                    let dx = t.clientX - centerX;
                    let dy = t.clientY - centerY;
                    const dist = Math.min(Math.sqrt(dx*dx + dy*dy), 35);
                    const angle = Math.atan2(dy, dx);
                    moveX = Math.cos(angle) * (dist/35);
                    moveZ = Math.sin(angle) * (dist/35);
                    document.getElementById('joystick-stick').style.transform = `translate(${Math.cos(angle)*dist}px, ${Math.sin(angle)*dist}px)`;
                } 
                // Lado Derecho: Cámara 360
                else {
                    const deltaX = t.clientX - lastTouchX;
                    const deltaY = t.clientY - lastTouchY;
                    yaw -= deltaX * 0.006;
                    pitch -= deltaY * 0.006;
                    pitch = Math.max(-Math.PI/2.2, Math.min(Math.PI/2.2, pitch));
                    lastTouchX = t.clientX;
                    lastTouchY = t.clientY;
                }
            }
        });

        window.addEventListener('touchend', e => {
            if (e.touches.length === 0) {
                moveX = 0; moveZ = 0;
                document.getElementById('joystick-stick').style.transform = 'translate(0,0)';
            }
        });

        let touchRunning = false;
        const runBtn = document.getElementById('btn-run');
        runBtn.addEventListener('touchstart', (e) => { e.preventDefault(); touchRunning = true; });
        runBtn.addEventListener('touchend', () => { touchRunning = false; });

        // --- LÓGICA DE JUEGO ---
        document.addEventListener('keydown', (e) => keys[e.key.toLowerCase()] = true);
        document.addEventListener('keyup', (e) => keys[e.key.toLowerCase()] = false);

        function loadLevel(n) {
            currentLevel = n;
            document.getElementById('lvl-tag').innerText = "NIVEL: " + n;
            if(n >= 50) { triggerFinal(); return; }
            
            collidableWalls.forEach(w => scene.remove(w)); collidableWalls = [];
            if(monster) scene.remove(monster); if(door) scene.remove(door); if(heart) scene.remove(heart);
            
            let wallCol = (n < 10) ? 0x998844 : (n < 25) ? 0x222222 : 0x445566;
            let fogCol = (n < 10) ? 0x1a1a05 : 0x050505;
            scene.background = new THREE.Color(fogCol);
            scene.fog = new THREE.Fog(fogCol, 1, 11);

            const floor = new THREE.Mesh(new THREE.PlaneGeometry(100, 100), new THREE.MeshLambertMaterial({color: 0x0a0a0a}));
            floor.rotation.x = -Math.PI/2; scene.add(floor);

            const wallMat = new THREE.MeshLambertMaterial({color: wallCol});
            for(let i = -30; i <= 30; i += 10) {
                for(let j = -30; j <= 30; j += 10) {
                    if(Math.abs(i) < 5 && Math.abs(j) < 5) continue;
                    const m = new THREE.Mesh(new THREE.BoxGeometry(8, 3, 0.5), wallMat);
                    m.position.set(i, 1.5, j);
                    scene.add(m); collidableWalls.push(m);
                }
            }

            door = new THREE.Mesh(new THREE.BoxGeometry(1.2, 2.2, 0.2), new THREE.MeshBasicMaterial({color: 0xff0000}));
            door.position.set(28, 1.1, 28); scene.add(door);

            monster = new THREE.Mesh(new THREE.BoxGeometry(0.6, 2, 0.6), new THREE.MeshBasicMaterial({color: 0x000000}));
            monster.position.set(-25, 1, -25); scene.add(monster);

            heart = new THREE.Mesh(new THREE.TorusGeometry(0.2, 0.08, 8, 16), new THREE.MeshBasicMaterial({color: 0xff0000}));
            heart.position.set(Math.random()*40-20, 1, Math.random()*40-20); scene.add(heart);

            camera.position.set(0, 1.6, 0);
        }

        function triggerFinal() {
            isFinal = true;
            document.getElementById('mobile-ui').style.display = 'none';
            document.getElementById('final-overlay').style.display = 'flex';
            setTimeout(() => {
                document.getElementById('final-overlay').style.background = "rgba(0,0,0,0.98)";
                const txt = document.getElementById('final-text');
                txt.style.opacity = 1;
                txt.innerHTML = "EL ABISMO TE RECLAMA...<br>NO HUBO SALVACIÓN.";
                setTimeout(setupHeaven, 8000);
            }, 500);
        }

        function setupHeaven() {
            inHeaven = true;
            document.getElementById('final-overlay').style.display = 'none';
            document.getElementById('ui').style.display = 'none';
            document.getElementById('lvl-tag').style.display = 'none';
            if(isMobile) document.getElementById('mobile-ui').style.display = 'block';
            scene.background = new THREE.Color(0xffffff);
            scene.fog = new THREE.Fog(0xffffff, 5, 60);
            heavenLight = new THREE.Mesh(new THREE.SphereGeometry(3, 32, 32), new THREE.MeshBasicMaterial({color: 0xffffaa}));
            heavenLight.position.set(0, 1.6, -60);
            scene.add(heavenLight);
            camera.position.set(0, 1.6, 0);
            yaw = 0; pitch = 0;
        }

        function animate() {
            requestAnimationFrame(animate);
            
            if (isMobile) camera.rotation.set(pitch, yaw, 0, 'YXZ');

            if (!isFinal && (controls.isLocked || isMobile)) {
                let isRunning = keys['shift'] || touchRunning;
                let speed = (isRunning && stamina > 0) ? 0.16 : 0.08;
                if(isRunning && stamina > 0) stamina -= 0.7; else if(stamina < 100) stamina += 0.25;
                document.getElementById('stamina-fill').style.width = stamina + "%";

                const old = camera.position.clone();
                if (!isMobile) {
                    if (keys.w) controls.moveForward(speed); if (keys.s) controls.moveForward(-speed);
                    if (keys.a) controls.moveRight(-speed); if (keys.d) controls.moveRight(speed);
                } else {
                    const fw = new THREE.Vector3(0,0,-1).applyQuaternion(camera.quaternion);
                    const rt = new THREE.Vector3(1,0,0).applyQuaternion(camera.quaternion);
                    fw.y = 0; rt.y = 0;
                    camera.position.addScaledVector(fw.normalize(), -moveZ * speed);
                    camera.position.addScaledVector(rt.normalize(), moveX * speed);
                }

                const pBox = new THREE.Box3().setFromCenterAndSize(camera.position, new THREE.Vector3(0.6,1,0.6));
                for(let w of collidableWalls) if(pBox.intersectsBox(new THREE.Box3().setFromObject(w))) camera.position.copy(old);

                if(monster) {
                    const mDir = new THREE.Vector3().subVectors(camera.position, monster.position).normalize();
                    monster.position.x += mDir.x * 0.045; monster.position.z += mDir.z * 0.045;
                    if (camera.position.distanceTo(monster.position) < 1.1) {
                        lives--; document.getElementById('lives').innerText = lives;
                        if(lives <= 0) location.reload(); else loadLevel(currentLevel);
                    }
                }
                if (door && camera.position.distanceTo(door.position) < 1.5) loadLevel(currentLevel + 1);
            } else if (inHeaven) {
                const fw = new THREE.Vector3(0,0,-1).applyQuaternion(camera.quaternion);
                fw.y = 0;
                if(isMobile) camera.position.addScaledVector(fw.normalize(), -moveZ * 0.07);
                else if(keys.w) controls.moveForward(0.07);

                const d = camera.position.distanceTo(heavenLight.position);
                if(d < 30) document.getElementById('heaven-msg').style.opacity = 1;
                if(d < 4) document.getElementById('victory-screen').style.display = 'flex';
            } else if (isFinal && !inHeaven) {
                camera.position.y = Math.max(0.1, camera.position.y - 0.005);
                camera.rotation.z += 0.01;
            }
            renderer.render(scene, camera);
        }

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

        loadLevel(0); animate();
    </script>
</body>
</html>